<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, maximum-scale=1.0">
<title>Simulatore Genetico Felino Inverso</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background:#eee; overflow-x: hidden; }
h2 { color:#333; }
.controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
select, button { font-size:16px; padding:6px 12px; border-radius:8px; border:1px solid #ccc; margin-bottom: 8px; }
button { cursor:pointer; background:#28f; color:#fff; transition:0.3s; }
button:hover{ filter: brightness(1.2); }
label { font-size: 16px; line-height: 2; }
p { font-size: 16px; line-height: 1.5; }

.cards { display:flex; flex-wrap:wrap; gap:10px; }
.card { position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center;
        padding:10px 15px; border-radius:12px; color:#fff; font-weight:bold; min-width:120px;
        cursor:pointer; transition:0.2s; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
.card:hover{ filter: brightness(1.2); }

.black{background:#444;color:#fff;}
.red{background:#c40;color:#000;}
.tortie{background:#442;color:#fff;}
.point{background:#fed;background:linear-gradient(to right, #444 0%, #fed 50%, #444 100%);color:#000;}
.gray{background:#666;color:#fff;}
.choco{background:#532;color:#fff;}
.lilac{background:#cac;color:#000;}
.white{background:#fff;color:#000;}

table { border-collapse: collapse; width: 100%; margin-top: 20px; background:#fff; border-radius:8px; overflow:hidden; }
th, td { border: 1px solid #ccc; padding: 8px; text-align:center; }
th { background:#28f; color:#fff; }
tr:hover{filter: brightness(1.2);}

.modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.5);}
.modal-content { background-color:#fff; margin:10% auto; padding:20px; border-radius:12px; width:90%; max-width:500px; position:relative;}
.close { position:absolute; top:10px; right:15px; font-size:24px; font-weight:bold; cursor:pointer;}

.group { display:flex; flex-direction:column; width: 280px; width: 32%; white-space: nowrap; }
.parents { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
.summary { margin-bottom: 20px; }
p { margin:0; padding:0; }

.img-search { cursor: pointer; }
.img-search:hover { filter: brightness(1.2); }

/* MOBILE FIX */
@media (max-width: 768px) {
  body { font-size: 20px; padding: 12px; }
  h2 { font-size: 24px; line-height: 1.3; }
  label { font-size: 20px; line-height: 2; }
  p { font-size: 20px; line-height: 1.5; }
  input[type="checkbox"] { transform: scale(1.3); margin-right: 6px; }
  select, button { font-size: 20px; padding: 10px 12px; }
  .group { width: 100%; }
  .card { font-size: 20px; min-width: 100%; padding: 14px; }
  .cards { justify-content: center; }
  table { font-size: 20px; }
  th, td { padding: 10px 6px; }
  .modal-content { margin: 15% auto; font-size: 20px; }
}
</style>
</head>

<body>
<h2>Simulatore Genetico Felino Inverso</h2>
<div class="controls">
	<div class="group">
		Sesso del figlio:
		<select id="sex">
			<option value="F">Femmina</option>
			<option value="M">Maschio</option>
		</select>
		Fenotipo:<br/>
		<select id="feno"></select>
	</div>
	<div class="group">
		Genotipo:<br/>
		<select id="f_redblack">
			<option value="o_o">Nero X·¥∫/X·¥∫ (o/o)</option>
			<option value="O_o">Nero e Rosso X·¥ø/X·¥∫ (O/o)</option>
			<option value="O_O">Rosso X·¥ø/X·¥ø (O/O)</option>
		</select>
		<select id="f_agouti">
			<option value="a_a">No Tabby a/a</option>
			<option value="A_a">Tabby Tigrato A/a</option>
			<option value="A_A">Tabby Tigrato A/A</option>
		</select>
		<select id="f_chocolate">
			<option value="B_B">Nero B/B</option>
			<option value="B_b">Nero portatore di Cioccolato B/b</option>
			<option value="b_b">Cioccolato b/b</option>
		</select>
		<select id="f_siamese">
			<option value="C_C">No Siamese C/C</option>
			<option value="C_cs">Siamese portatore C/cs</option>
			<option value="cs_cs">Siamese cs/cs</option>
		</select>
		<select id="f_diluizione">
			<option value="D_D">Colore Pieno D/D</option>
			<option value="D_d">Colore Pieno portatore Diluizione D/d</option>
			<option value="d_d">Colore Diluito d/d</option>
		</select>
		<select id="f_spotted">
			<option value="s_s">No Spotting Bianco s/s</option>
			<option value="S_s">Spotting moderato Bianco S/s</option>
			<option value="S_S">Spotting molto Bianco S/S</option>
		</select>
		<select id="f_white">
			<option value="w_w">No Bianco uniforme w/w</option>
			<option value="W_w">Bianco uniforme W/w</option>
			<option value="W_W">Bianco uniforme W/W</option>
		</select>
		<select id="f_hair">
			<option value="L_L">Pelo Corto L/L</option>
			<option value="L_l">Pelo Lungo portatore L/l</option>
			<option value="l_l">Pelo Lungo l/l</option>
		</select>
	</div>
	<div class="group">
		Genitori compatibili:
		<button onclick="calcola()">Calcola</button>
	</div>
</div>
<hr />
<div id="result"></div>

<script>
const COLORS_FEMALE = [
	"nero uniforme", "bianco uniforme", "grigio uniforme",
	"tigrato grigio", "tigrato rosso",
	"siamese seal", "siamese chocolate", "siamese blue", "siamese lilac", "siamese tabby",
	"tuxedo", "tigrato grigio + bianco", "tigrato rosso + bianco",
	"calico", "tortie"
];

const COLORS_MALE = [
	"nero uniforme", "bianco uniforme", "grigio uniforme",
	"tigrato grigio", "tigrato rosso",
	"siamese seal", "siamese chocolate", "siamese blue", "siamese lilac", "siamese tabby",
	"tuxedo", "tigrato grigio + bianco", "tigrato rosso + bianco"
];
function updateDropdownSex() {
	const s = document.getElementById("feno");
	const isFemale = document.getElementById("sex").value === "F";
	const list = (isFemale ? COLORS_FEMALE : COLORS_MALE);
	s.innerHTML = "";//svuota
	list.forEach(c => {
		const o = document.createElement("option");
		o.value = c;
		o.text = c;
		s.appendChild(o);
	});
}
function updateDropdownFeno() {
	const isFemale = document.getElementById("sex").value === "F";
	const color = document.getElementById("feno").value;
	
	// ---- O (rosso / nero x-linked)
	if (isFemale) {
		document.getElementById("f_redblack").value = 
			(color.includes("tortie") || color.includes("calico")) ? "O_o" :
			color.includes("rosso") ? "O_O" :
			"o_o";
	} else {
		document.getElementById("f_redblack").value = 
			color.includes("rosso") ? "O_Y" : "o_Y";
	}
	
	// ---- D (diluizione)
	document.getElementById("f_diluizione").value =
		(color.includes("grigio") || color.includes("blue") || color.includes("lilac")) ?
		"d_d" :
		"D_D";

	// ---- B (chocolate)
	document.getElementById("f_chocolate").value =
		(color.includes("chocolate") || color.includes("lilac")) ?
		"b_b" :
		"B_B";

	// ---- A (agouti)
	document.getElementById("f_agouti").value =
		(color.includes("tigrato") || color.includes("tabby")) ?
		"A_A" :
		"a_a";

	// ---- cs (siamese)
	document.getElementById("f_siamese").value =
		color.includes("siamese") ?
		"cs_cs" :
		"C_C";

	// ---- S (spotting)
	document.getElementById("f_spotted").value =
		(color.includes("bianco") || color.includes("tuxedo") || color.includes("calico")) ?
		"S_S" :
		"s_s";

	// ---- W (white dominante)
	document.getElementById("f_white").value =
		color === "bianco uniforme" ?
		"W_W" :
		"w_w";

	// ---- H (pelo) ‚Üí neutro
	document.getElementById("f_hair").value = "L_L";
}

// EVENTI
document.getElementById("feno").addEventListener("change", () => {
	updateDropdownFeno();
});

document.getElementById("sex").addEventListener("change", () => {
    updateDropdownSex();   //aggiorna i nomi dei colori (es. aggiunge/toglie Tortie)
    aggiornaRedBlack();    //aggiorna le opzioni genetiche (es. X/X o X/Y)
});


// INIT
updateDropdownSex();
updateDropdownFeno();




// ================== UTILITY ==================
function aggiornaRedBlack() {
	const sex = document.getElementById("sex").value;
	const sel = document.getElementById("f_redblack");
	const current = sel.value;

	sel.innerHTML = ""; // reset

	if (sex === "M") {
		// maschio: solo O/Y e o/Y
		sel.innerHTML += `<option value="o_Y">Nero X·¥∫/Y (o/Y)</option>`;
		sel.innerHTML += `<option value="O_Y">Rosso X·¥ø/Y (O/Y)</option>`;

	} else {
		// femmina: tutte le opzioni
		sel.innerHTML += `<option value="o_o">Nero X·¥∫/X·¥∫ (o/o)</option>`;
		sel.innerHTML += `<option value="O_o">Nero e Rosso X·¥ø/X·¥∫ (O/o)</option>`;
		sel.innerHTML += `<option value="O_O">Rosso X·¥ø/X·¥ø (O/O)</option>`;
	}

	// cerca di mantenere la selezione precedente se possibile
	if ([...sel.options].some(o => o.value === current)) {
		sel.value = current;
	}
}

// aggiorna al cambio di sesso
document.getElementById("sex").addEventListener("change", aggiornaRedBlack);

// inizializza la select
aggiornaRedBlack();

function gameti(g) {
	const [a, b] = g.split("_");
	return a === b ? [a] : [a, b];
}

function gametiXlinked(g, sex) {
	if (sex === "M") {
		return [g.split("_")[0]]; // solo O o o
	}
	const [a, b] = g.split("_");
	return a === b ? [a] : [a, b];
}


function incrocio(gm, gp) {
	let res = {};
	gm.forEach(m => gp.forEach(p => {
		const f = [m, p].sort().join("_");
		res[f] = (res[f] || 0) + 1;
	}));
	const tot = gm.length * gp.length;
	Object.keys(res).forEach(k => res[k] /= tot);
	return res;
}

// ================== AUTOSOMICO ==================
function genitoriAutosomico(locus, valore) {
	const [A, B] = valore.split("_");
	const alleli = [...new Set([A, B])];

	let possibili =
		alleli.length === 1
			? [`${A}_${A}`]
			: [`${A}_${A}`, `${A}_${B}`, `${B}_${B}`];

	let res = [];

	possibili.forEach(m => {
		possibili.forEach(p => {
			const figli = incrocio(gameti(m), gameti(p));
			if (figli[valore]) {
				res.push({
					madre: { [locus]: m },
					padre: { [locus]: p },
					prob: figli[valore]
				});
			}
		});
	});

	return res;
}


function fenotipo(geni) {
	const f = {};

	// ================= ORANGE (X-linked) =================
	switch (geni.O) {
		case "O_O":
		case "O_Y":
			f.colore = "rosso";
			break;
		case "O_o":
			f.colore = "tortie";
			break;
		case "o_o":
		case "o_Y":
			f.colore = "nero";
			break;
	}

	// ================= AGOUTI / TABBY =================
	if (geni.A === "A_A" || geni.A === "A_a") {
		f.tabby = "tabby";
	} else {
		f.tabby = "solido";
	}

	// ================= CHOCOLATE =================
	if (geni.B === "b_b") {
		f.base = "cioccolato";
	} else {
		f.base = "nero";
	}

	// ================= DILUIZIONE =================
	if (geni.D === "d_d") {
		f.diluizione = true;
	}

	// ================= SIAMESE / POINT =================
	if (geni.Cs === "cs_cs") {
		f.point = true;
	}

	// ================= WHITE DOMINANTE =================
	if (geni.W !== "w_w") {
		return "bianco uniforme";
	}

	// ================= COMPOSIZIONE COLORE =================
	let descrizione = [];

	// TORTIE
	if (f.colore === "tortie") {
		descrizione.push("tortie");
	}
	// ROSSO / CREMA (B irrilevante)
	else if (f.colore === "rosso") {
		descrizione.push(f.diluizione ? "crema" : "rosso");
	}
	// BASE NERA / CIOCCOLATO
	else {
		let base = (geni.B === "b_b") ? "cioccolato" : "nero";

		if (f.diluizione) {
			base = base === "cioccolato" ? "lilac" : "grigio";
		}
		descrizione.push(base);
	}


	// ================= TABBY =================
	if (f.tabby === "tabby") {
		descrizione.push("tabby");
	}

	// ================= POINT =================
	if (f.point) {
		descrizione.push("point");
	}

	// ================= WHITE SPOTTING =================
	if (geni.S === "S_s") descrizione.push("con bianco");
	if (geni.S === "S_S") descrizione.push("molto bianco");

	// ================= PELO =================
	switch (geni.H) {
		case "l_l":
			descrizione.push("pelo lungo");
			break;
		case "L_l":
			descrizione.push("pelo corto");
			break;
		case "L_L":
			descrizione.push("pelo corto");
			break;
	}

	return descrizione.join(" ");
}



function sortGeno(g) {
	const [a, b] = g.split("_");
	return [a, b].sort().join("_");
}


// ================== ORANGE X-LINKED ==================
function genitoriOrange(valore, sex) {
	let res = [];

	if (sex === "M") {
		const allele = valore.split("_")[0];
		["O_O", "O_o", "o_o"].forEach(m => {
			const gm = gametiXlinked(m, "F");
			if (gm.includes(allele)) {
				res.push({
					madre: { O: m },
					padre: { O: allele + "_Y" },
					prob: 1 / gm.length
				});
			}
		});
	} else {
		["O_O", "O_o", "o_o"].forEach(m => {
			["O_Y", "o_Y"].forEach(p => {
				const gm = gametiXlinked(m, "F");
				gm.forEach(ma => {
					const f = [ma, p[0]].sort().join("_");
					if (f === valore) {
						res.push({
							madre: { O: m },
							padre: { O: p },
							prob: 1 / gm.length
						});
					}
				});
			});
		});
	}

	return res;
}




function getColorClass(ph) {
	const p = ph.toLowerCase();

	// Dominanti visivi
	if (p.includes("bianco")) return "white";
	if (p.includes("point") || p.includes("siamese")) return "point";

	// Base di colore
	if (p.includes("tortie")) return "tortie";
	if (p.includes("rosso") || p.includes("crema")) return "red";

	// Varianti del nero
	if (p.includes("lilac")) return "lilac";
	if (p.includes("cioccolato")) return "choco";
	if (p.includes("grigio")) return "gray";
	if (p.includes("nero")) return "black";

	return "";
}

function openGoogleImages(query) {
	const q = encodeURIComponent("gatto " + query);
	const url = `https://www.google.com/search?tbm=isch&q=${q}`;
	window.open(
		url,
		"imgPopup",
		"width=900,height=700,scrollbars=yes,resizable=yes"
	);
}

function denominazioneFIFE(geni, sex) {

	// --- WHITE DOMINANTE ---
	if (geni.W !== "w_w") return "w";

	// --- POINT ---
	const isPoint = geni.Cs === "cs_cs";

	// --- TABBY ---
	let pattern = "";
	if (geni.A !== "a_a") {
		pattern = "21"; // tabby generico
	}

	// --- DILUIZIONE ---
	const isDiluted = geni.D === "d_d";

	// --- ORANGE / TORTIE ---
	let colore = "";

	const isRed =
		(sex === "M" && geni.O === "O_Y") ||
		(sex === "F" && geni.O === "O_O");

	const isTortie =
		(sex === "F" && geni.O === "O_o");

	if (isTortie) {
		colore = isDiluted ? "g" : "f"; // blu tortie / nero tortie
	}
	else if (isRed) {
		colore = isDiluted ? "e" : "d"; // crema / rosso
	}
	else {
		// --- BASE NERO / CIOCCOLATO ---
		if (geni.B === "b_b") {
			colore = isDiluted ? "p" : "b"; // lilac / chocolate
		} else {
			colore = isDiluted ? "a" : "n"; // blu / nero
		}
	}

	// --- BIANCO ---
	let white = "";
	if (geni.S === "S_s") white = "09";
	if (geni.S === "S_S") white = "03";

	// --- POINT OVERRIDE ---
	if (isPoint) pattern = "33";

	return [colore, pattern, white].filter(Boolean).join(" ");
}



// ================== COMBINAZIONE ==================
function combina(liste) {
	let res = [{
		madre: {},
		padre: {},
		prob: 1
	}];

	liste.forEach(l => {
		let tmp = [];
		res.forEach(r => {
			l.forEach(x => {
				tmp.push({
					madre: { ...r.madre, ...x.madre },
					padre: { ...r.padre, ...x.padre },
					prob: r.prob * x.prob
				});
			});
		});
		res = tmp;
	});

	const tot = res.reduce((s, r) => s + r.prob, 0);
	res.forEach(r => r.prob /= tot);

	return res.filter(r => r.prob > 0.01);
}


// ================== MAIN ==================
function calcola() {
	const sex = document.getElementById("sex").value;

	const f_redblack = document.getElementById("f_redblack");
	const f_agouti = document.getElementById("f_agouti");
	const f_chocolate = document.getElementById("f_chocolate");
	const f_siamese = document.getElementById("f_siamese");
	const f_diluizione = document.getElementById("f_diluizione");
	const f_spotted = document.getElementById("f_spotted");
	const f_white = document.getElementById("f_white");
	const f_hair = document.getElementById("f_hair");

	let orange = f_redblack.value;

	//FORZATURA BIOLOGICA
	if (sex === "M") {
		const allele = orange.startsWith("O") ? "O" : "o";
		orange = allele + "_Y";
	}

	const geni = {
		O:  orange,
		A:  f_agouti.value,
		B:  f_chocolate.value,
		Cs: f_siamese.value,
		D:  f_diluizione.value,
		S:  f_spotted.value,
		W:  f_white.value,
		H:  f_hair.value
	};

	
	let htmlCucciolo = `
		<p><strong>${sex === "F" ? "ü©∑" : "ü©µ"} Loci cucciolo:</strong></p>
		<p>Sesso: ${sex}</p>
		<p>O: ${geni.O.replace("_"," / ")}</p>
		<p>A: ${geni.A.replace("_"," / ")}</p>
		<p>B: ${geni.B.replace("_"," / ")}</p>
		<p>Cs: ${geni.Cs.replace("_"," / ")}</p>
		<p>D: ${geni.D.replace("_"," / ")}</p>
		<p>S: ${geni.S.replace("_"," / ")}</p>
		<p>W: ${geni.W.replace("_"," / ")}</p>
		<p>H: ${geni.H.replace("_"," / ")}</p>
		<p>FIFe: ${denominazioneFIFE(geni, sex)}</p>
		<hr/>`;
	document.getElementById("result").innerHTML = htmlCucciolo;

	const perGene = [
		genitoriOrange(geni.O, sex),
		genitoriAutosomico("A", geni.A),
		genitoriAutosomico("B", geni.B),
		genitoriAutosomico("Cs", geni.Cs),
		genitoriAutosomico("D", geni.D),
		genitoriAutosomico("S", geni.S),
		genitoriAutosomico("W", geni.W),
		genitoriAutosomico("H", geni.H)
	];



	// se un gene non ha soluzioni, non ha senso combinare
	if (perGene.some(g => g.length === 0)) {
		document.getElementById("result").innerHTML +=
			"<b>Nessuna combinazione genetica possibile con i valori selezionati.</b>";
		return;
	}

	const comb = combina(perGene);

	if (comb.length === 0) {
		document.getElementById("result").innerHTML +=
			"<b>Nessuna combinazione con probabilit√† &gt; 1%.</b>";
		return;
	}

	let html = `<div class="section"><h3>Genitori compatibili:</h3><table>
    <tr><th>Madre</th><th>Padre</th><th>Probabilit√†</th></tr>`;

	comb.forEach(c => {
		html += `<tr>
        <td onclick="openGoogleImages('${fenotipo(c.madre)}');" 
			class="${getColorClass(fenotipo(c.madre))}">${fenotipo(c.madre)} üîç<br/>
			<br/>${Object.values(c.madre).join(", ").replaceAll("_","/")}<br/>
			<br/>FIFe: ${denominazioneFIFE(c.madre, "F")}
			</td>
		<td onclick="openGoogleImages('${fenotipo(c.padre)}');"
			class="${getColorClass(fenotipo(c.padre))}">${fenotipo(c.padre)} üîç<br/>
			<br/>${Object.values(c.padre).join(", ").replaceAll("_","/")}<br/>
			<br/>FIFe: ${denominazioneFIFE(c.padre, "M")}
			</td>
        <td>${(c.prob * 100).toFixed(2)}%</td>
    </tr>`;
	});

	html += "</table></div>";
	document.getElementById("result").innerHTML += html;

}

// ------------------------------
// 8. MODAL
// ------------------------------
function openModal(title, content) {
	document.getElementById("modal-title").innerText = title;
	document.getElementById("modal-body").innerHTML = content;
	document.getElementById("modal").style.display = "block";
}

function closeModal() {
	document.getElementById("modal").style.display = "none";
}
</script>

</body>
</html>
