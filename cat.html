<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Simulatore genetico felino ‚Äî Mendel Completo</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background:#eee; }
h2 { color:#333; }
.controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
select, button { font-size:16px; padding:6px 12px; border-radius:8px; border:1px solid #ccc; margin-bottom: 8px; }
button { cursor:pointer; background:#4b4; color:white; transition:0.3s; }
button:hover{ filter: brightness(1.2); }

.cards { display:flex; flex-wrap:wrap; gap:10px; }
.card { position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center;
        padding:10px 15px; border-radius:12px; color:white; font-weight:bold; min-width:120px;
        cursor:pointer; transition:0.2s; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
.card:hover{ filter: brightness(1.2); }

.black{background:#444;color:#fff;}
.red{background:#c40;color:#000;}
.tortie{background:#442;color:#fff;}
.point{background:#fed;background:linear-gradient(to right, #444 0%, #fed 50%, #444 100%);color:#000;}
.gray{background:#666;color:#fff;}
.choco{background:#532;color:#fff;}
.lilac{background:#cac;color:#000;}
.white{background:#eee;color:#000;}

table { border-collapse: collapse; width: 100%; margin-top: 20px; background:#fff; border-radius:8px; overflow:hidden; }
th, td { border: 1px solid #ccc; padding: 8px; text-align:center; }
th { background: #4b4; }
tr:hover{filter: brightness(1.2);}

.modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.5);}
.modal-content { background-color:#fff; margin:10% auto; padding:20px; border-radius:12px; width:90%; max-width:500px; position:relative;}
.close { position:absolute; top:10px; right:15px; font-size:24px; font-weight:bold; cursor:pointer;}

.group { display:flex; flex-direction:column; width: 280px; }
.parents { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
.summary { margin-bottom: 20px; }
p { margin:0; padding:0; }

.img-search { cursor: pointer; }
.img-search:hover { filter: brightness(1.2); }
</style>
</head>
<body>

<h2>Simulatore genetico felino ‚Äî Mendel Completo</h2>

<div class="controls">
  <div class="group">
    <select id="female"></select>  
    <label><input type="checkbox" id="f_carrier_d"/> Portatrice diluizione (d)</label><br/>
    <label><input type="checkbox" id="f_carrier_b"/> Portatrice chocolate (b)</label><br/>
    <label><input type="checkbox" id="f_tabby"/> Tabby eterozigote (A/a)</label><br/>
	<label><input type="checkbox" id="f_carrier_cs"/>Portatrice siamese (cs)</label><br/>
	<label><input type="checkbox" id="f_carrier_s"/>Spotting bianco (S/s)</label><br/>
  </div>
  
  <div class="group">
	<select id="male"></select>
    <label><input type="checkbox" id="m_carrier_d"/> Portatore diluizione (d)</label><br/>
    <label><input type="checkbox" id="m_carrier_b"/> Portatore chocolate (b)</label><br/>
    <label><input type="checkbox" id="m_tabby"/> Tabby eterozigote (A/a)</label><br/>
	<label><input type="checkbox" id="m_carrier_cs"/>Portatore siamese (cs)</label><br/>
	<label><input type="checkbox" id="m_carrier_s"/>Spotting bianco (S/s)</label><br/>
  </div>
  
  <div class="group">
	<button onclick="calcola()">Genera combinazioni</button> 
	<label><input type="checkbox" id="show_comb_all"/>Mostra combinazioni tutte</label>
	<label><input type="checkbox" id="show_comb_uni" checked="checked"/>Mostra combinazioni uniche</label>
  </div>
</div>

<hr/>

<div id="result"></div>

<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3 id="modal-title"></h3>
    <div id="modal-body"></div>
  </div>
</div>

<script>
function updateCheckboxes(parent) {
  const select = document.getElementById(parent);
  const color = select.value;

  const isFemale = parent === "female";

  const boxes = {
    carrierD:  document.getElementById(isFemale ? "f_carrier_d"  : "m_carrier_d"),
    carrierB:  document.getElementById(isFemale ? "f_carrier_b"  : "m_carrier_b"),
    tabby:     document.getElementById(isFemale ? "f_tabby"      : "m_tabby"),
	carrierCs: document.getElementById(isFemale ? "f_carrier_cs" : "m_carrier_cs"),
	carrierS:  document.getElementById(isFemale ? "f_carrier_s"  : "m_carrier_s")
  };

  // ---------- D locus (diluizione)
  if (color.includes("grigio") || color.includes("blue") || color.includes("lilac")) {
    boxes.carrierD.checked = true;     // dd
    boxes.carrierD.disabled = true;
  } else {
    boxes.carrierD.checked = false;    // DD o Dd
    boxes.carrierD.disabled = false;
  }

  // ---------- B locus (chocolate)
  if (color.includes("chocolate") || color.includes("lilac")) {
    boxes.carrierB.checked = true;     // bb
    boxes.carrierB.disabled = true;
  } else {
    boxes.carrierB.checked = false;    // BB o Bb
    boxes.carrierB.disabled = false;
  }

  // ---------- A locus (tabby)
  if (color.includes("tigrato") || color.includes("tabby")) {
    boxes.tabby.disabled = false;   // pu√≤ essere A/A o A/a
    boxes.tabby.checked = false;    // default A/A
  } else {
    boxes.tabby.checked = false;    // solido -> aa
    boxes.tabby.disabled = true;
  }
  
  // ---------- Cs locus (siamese)
  if (color.includes("siamese")) {
	boxes.carrierCs.checked = true;   // cscs
	boxes.carrierCs.disabled = true;
  } else {
	boxes.carrierCs.checked = false;  // CC o Ccs
	boxes.carrierCs.disabled = false;
  }
  
  // ------- SPOTTED
  if (color === "bianco uniforme") {
    boxes.carrierS.disabled = true;
	boxes.carrierS.checked = false;
  } else if ( color.includes("bianco") || color.includes("tuxedo") || color.includes("calico") ) {
    boxes.carrierS.disabled = false;//ha spotting -> puo essere SS o Ss
  } else {
	//potrebbe essere portatore 
	boxes.carrierS.disabled = false;
  }  
}

document.getElementById("female").addEventListener("change", () => {
  updateCheckboxes("female");
});

document.getElementById("male").addEventListener("change", () => {
  updateCheckboxes("male");
});

// stato iniziale
updateCheckboxes("female");
updateCheckboxes("male");




// ------------------------------
// 1. LISTE FENOTIPI
// ------------------------------
const COLORS_FEMALE = [
  "nero uniforme","bianco uniforme","rosso uniforme","grigio uniforme",
  "tigrato grigio","tigrato rosso",
  "siamese seal","siamese chocolate","siamese blue","siamese tabby",
  "tuxedo","tigrato grigio + bianco","tigrato rosso + bianco",
  "calico","tortie"
];

const COLORS_MALE = [
  "nero uniforme","bianco uniforme","rosso uniforme","grigio uniforme",
  "tigrato grigio","tigrato rosso",
  "siamese seal","siamese chocolate","siamese blue","siamese tabby",
  "tuxedo","tigrato grigio + bianco","tigrato rosso + bianco"
];

// ------------------------------
// 2. POPOLAMENTO MENU
// ------------------------------
["female","male"].forEach(id => {
  const s = document.getElementById(id);
  const list = ( id === "female" ? COLORS_FEMALE : COLORS_MALE );
  list.forEach(c => {
    const o = document.createElement("option");
    o.value = c;
    o.text = (id === "female" ? "MADRE: " : "PADRE: " ) + c;
    s.appendChild(o);
  });
});

// ------------------------------
// 3. TRADUZIONE FENOTIPO ‚Üí GENOTIPO (Mendeliano)
// ------------------------------
function translateCat(color, sex, opt = {}){
  const loci = {};

  // D locus (diluizione)
  if (color.includes("grigio") || color.includes("blue") || color.includes("lilac"))
	loci.D = ["d","d"];
  else if (opt.carrierD)
	loci.D = ["D","d"];
  else
    loci.D = ["D","D"];//non portatore di diluizione

  // B locus (chocolate)
  if (color.includes("chocolate") || color.includes("lilac"))
    loci.B = ["b","b"];
  else if (opt.carrierB)
	loci.B = ["B","b"];
  else
    loci.B = ["B","B"];//non portatore

  // A locus (tabby) √® particolare
  if (color.includes("tigrato") || color.includes("tabby")) {
	if (opt.tabby) loci.A = ["A","a"];
	else loci.A = ["A","A"];
  } else {
	loci.A = ["a","a"];//non tigrato
  }


  // Cs locus (siamese)
  if (color.includes("siamese"))
	loci.Cs = ["cs","cs"];//recessivo omozigote obbligato
  else if (opt.carrierCs)
    loci.Cs = ["C","cs"];//eterozigote = portatore
  else
    loci.Cs = ["C","C"];//dominante omozigote = non siamese


  // W locus (bianco dominante)
  if (color === "bianco uniforme")
    loci.W = ["W","w"];
  else
    loci.W = ["w","w"];

  
  // S locus (white spotting)
  if (color === "bianco uniforme") {
    loci.S = ["s","s"]; // W maschera tutto == non spotted
  } 
  else if (color === "tuxedo" || color === "calico") {
  loci.S = ["S","s"]; // come nella realta
  }
  else if (opt.carrierS) {
    loci.S = ["S","s"]; // portatore con bianco
  }
  else if (color.includes("bianco")) {
    loci.S = ["S","S"]; // bianco visibile ma non portatore
  }
  else {
    loci.S = ["s","s"]; // nessun bianco
  }
  

  // O locus (rosso X-linked)
  if (sex === "Madre") {
    if (color.includes("tortie") || color.includes("calico"))
      loci.O = ["X·¥ø","X·¥∫"];
    else if (color.includes("rosso"))
      loci.O = ["X·¥ø","X·¥ø"];
    else
      loci.O = ["X·¥∫","X·¥∫"];
  } else {
    loci.O = color.includes("rosso") ? ["X·¥ø","Y"] : ["X·¥∫","Y"];
  }

  loci.sex = sex === "Madre" ? "Femmina" : "Maschio";
  return loci;
}

// ------------------------------
// 4. GAMETI -> non del tutto corretto ma per ora va bene cosi
// ------------------------------
function gametes(alleles){
  return [ alleles[0], alleles[1] ];
}

// ------------------------------
// 5. COMBINAZIONE DI UN LOCUS
// ------------------------------
function combineLocus(mother, father){
  const gM = gametes(mother);
  const gF = gametes(father);
  const combos = [];

  for (let m of gM){
    for (let f of gF){
      combos.push([m,f]);
    }
  }
  return combos;
}

// ------------------------------
// 6. FENOTIPO DA GENOTIPO
// ------------------------------
function has(pair, allele){ return pair.includes(allele); }

function phenotype(loci){
  if (has(loci.W,"W")) return "bianco uniforme";

  let base;

  if (loci.sex === "Maschio"){
    base = has(loci.O,"X·¥ø") ? "rosso" : "nero";
  } else {
    const r = has(loci.O,"X·¥ø");
    const n = has(loci.O,"X·¥∫");
    if (r && n) base = "tortie";
    else base = r ? "rosso" : "nero";
  }

  if (base.includes("nero") && loci.B[0]==="b" && loci.B[1]==="b")
    base = "chocolate";

  if (loci.D[0]==="d" && loci.D[1]==="d"){
    base = base.replace("nero","grigio")
               .replace("chocolate","lilac")
               .replace("rosso","crema");
  }

  if (has(loci.A,"A")) base = "tigrato " + base;
  if (loci.Cs[0]==="cs" && loci.Cs[1]==="cs") base = "siamese " + base;
  if (has(loci.S,"S")) base += " + bianco";

  return base;
}

// ------------------------------
// 7. CLASSE COLORE
// ------------------------------
function getColorClass(ph){
  if (ph.includes("nero")) return "black";
  if (ph.includes("rosso")||ph.includes("crema")) return "red";
  if (ph.includes("tortie")) return "tortie";
  if (ph.includes("siamese")) return "point";
  if (ph.includes("grigio")) return "gray";
  if (ph.includes("bianco uniforme")) return "white";
  if (ph.includes("chocolate")) return "choco";
  if (ph.includes("lilac")) return "lilac";
  return "";
}

function lociToHtml(l) {
  let res = `<p>O: ${l.O.join(" / ")}</p>`;
  res += `<p>A: ${l.A.join(" / ")}</p>`;
  res += `<p>B: ${l.B.join(" / ")}</p>`;
  res += `<p>D: ${l.D.join(" / ")}</p>`;
  res += `<p>Cs: ${l.Cs.join(" / ")}</p>`;
  res += `<p>S: ${l.S.join(" / ")}</p>`;
  res += `<p>W: ${l.W.join(" / ")}</p>`;
  return res;
}

// ------------------------------
// 8. MODAL
// ------------------------------
function openModal(title, content){
  document.getElementById("modal-title").innerText = title;
  document.getElementById("modal-body").innerHTML = content;
  document.getElementById("modal").style.display = "block";
}
function closeModal(){ document.getElementById("modal").style.display = "none"; }

function openGoogleImages(query) {
  const q = encodeURIComponent("gatto " + query);
  const url = `https://www.google.com/search?tbm=isch&q=${q}`;
  window.open(
    url,
    "imgPopup",
    "width=900,height=700,scrollbars=yes,resizable=yes"
  );
}


// ------------------------------
// 9. CALCOLO COMBINAZIONI MENDELIANE COMPLETE
// ------------------------------
function calcola(){
  const mother = document.getElementById("female").value;
  const father = document.getElementById("male").value;

  const motherOpt = {
	carrierD: document.getElementById("f_carrier_d").checked,
	carrierB: document.getElementById("f_carrier_b").checked,
	tabby:    document.getElementById("f_tabby").checked,
	carrierCs:document.getElementById("f_carrier_cs").checked,
	carrierS: document.getElementById("f_carrier_s").checked
  };

  const fatherOpt = {
	carrierD: document.getElementById("m_carrier_d").checked,
	carrierB: document.getElementById("m_carrier_b").checked,
	tabby:    document.getElementById("m_tabby").checked,
	carrierCs:document.getElementById("m_carrier_cs").checked,
	carrierS: document.getElementById("m_carrier_s").checked
  };

  const m = translateCat(mother, "Madre", motherOpt);
  const f = translateCat(father, "Padre", fatherOpt);

  const Ocomb = combineLocus(m.O, f.O);
  const Acomb = combineLocus(m.A, f.A);
  const Bcomb = combineLocus(m.B, f.B);
  const Dcomb = combineLocus(m.D, f.D);
  const Cscomb = combineLocus(m.Cs, f.Cs);
  const Scomb = combineLocus(m.S, f.S);
  const Wcomb = combineLocus(m.W, f.W);

  const combinations = [];

  for (let O of Ocomb){
    const sex = O.includes("Y") ? "Maschio" : "Femmina";

    if (sex==="Maschio" && O.includes("X·¥ø") && O.includes("X·¥∫")) continue;

    for (let A of Acomb){
      for (let B of Bcomb){
        for (let D of Dcomb){
          for (let Cs of Cscomb){
            for (let S of Scomb){
              for (let W of Wcomb){
                combinations.push({O,A,B,D,Cs,S,W,sex});
              }
            }
          }
        }
      }
    }
  }

  if (combinations.length === 0){
    document.getElementById("result").innerHTML="<p>Nessuna combinazione valida.</p>";
    return;
  }

  const prob = 1/combinations.length*100;
  const summary={};

  combinations.forEach(c=>{
    const ph = phenotype(c);
    summary[ph]=(summary[ph]||0)+prob;
  });


  let html=`<div class="parents"><div class="group">`;
  html += `<p class="img-search" onclick="openGoogleImages('${mother}'); return false;"><strong>ü©∑ Madre:</strong> ${mother} üîç</p>`;
  html += lociToHtml(m);
  html += `</div><div class="group">`;
  html += `<p class="img-search" onclick="openGoogleImages('${father}'); return false;"><strong>ü©µ Padre:</strong> ${father} üîç</p>`;
  html += lociToHtml(f);
  html += `</div></div>`;


  html+=`<table class="summary"><tr><th>Fenotipo</th><th>Probabilit√†</th></tr>`;
  Object.entries(summary).sort((a,b)=>b[1]-a[1]).forEach(([ph,p])=>{
    html+=`<tr class="${getColorClass(ph)} img-search" onclick="openGoogleImages('${ph}');return false;"><td>${ph} üîç</td><td>${p.toFixed(2)}%</td></tr>`;
  });
  html+=`</table>`;


  let show_comb_all = document.getElementById("show_comb_all").checked;
  if(show_comb_all) {
	  html+=`<div class="cards">`;
	  combinations.forEach(c=>{
		const ph=phenotype(c);
		const colorClass=getColorClass(ph);
		const icon=c.sex==="Femmina"?"ü©∑":"ü©µ";

		const lociText = `
		  <p><strong>Loci cucciolo:</strong></p>
		  <p>Sesso: ${c.sex}<p/>
		  <p>O: ${c.O.join(" / ")}<p/>
		  <p>A: ${c.A.join(" / ")}<p/>
		  <p>B: ${c.B.join(" / ")}<p/>
		  <p>D: ${c.D.join(" / ")}<p/>
		  <p>Cs: ${c.Cs.join(" / ")}<p/>
		  <p>S: ${c.S.join(" / ")}<p/>
		  <p>W: ${c.W.join(" / ")}<p/>
		  <hr/>
		  <p>Probabilit√†: ${prob.toFixed(2)}%</p>
		`;

		html+=`<div class="card ${colorClass}" onclick="openModal('${c.sex}: ${ph}', \`${lociText}\`)">${icon}<br/>${c.sex}<br/>${ph}</div>`;
	  });
	  html+=`</div>`;
  }
  
  let show_comb_uni = document.getElementById("show_comb_uni").checked;
  if(show_comb_uni) {
	  html += `<div class="cards">`;

	  const seen = {}; //oggetto { key: { loci: c, prob: somma_prob } }
	  const probPerCombo = 1 / combinations.length * 100;

	  combinations.forEach(c => {
		// crea una chiave unica per il genotipo
		const key = [
		  c.O.slice().sort().join(''),
		  c.A.slice().sort().join(''),
		  c.B.slice().sort().join(''),
		  c.D.slice().sort().join(''),
		  c.Cs.slice().sort().join(''),
		  c.S.slice().sort().join(''),
		  c.W.slice().sort().join('')
		].join('|');

		if(seen[key]) {
		  // aggiungi la probabilit√† se gi√† esiste
		  seen[key].prob += probPerCombo;
		} else {
		  seen[key] = { loci: c, prob: probPerCombo };
		}
	  });

	  // ora mostri solo i cuccioli unici
	  Object.values(seen).forEach(entry => {
		const c = entry.loci;
		const ph = phenotype(c);
		const colorClass = getColorClass(ph);
		const icon = c.sex === "Femmina" ? "ü©∑" : "ü©µ";

		const lociText = `
		  <p><strong>Loci cucciolo:</strong></p>
		  <p>Sesso: ${c.sex}<p/>
		  <p>O: ${c.O.join(" / ")}<p/>
		  <p>A: ${c.A.join(" / ")}<p/>
		  <p>B: ${c.B.join(" / ")}<p/>
		  <p>D: ${c.D.join(" / ")}<p/>
		  <p>Cs: ${c.Cs.join(" / ")}<p/>
		  <p>S: ${c.S.join(" / ")}<p/>
		  <p>W: ${c.W.join(" / ")}<p/>
		  <hr/>
		  <p>Probabilit√†: ${entry.prob.toFixed(2)}%</p>
		`;

		html += `<div class="card ${colorClass}" onclick="openModal('${c.sex}: ${ph}', \`${lociText}\`)">${icon}<br/>${c.sex}<br/>${ph}</div>`;
	  });

	  html += `</div>`;
	}


  document.getElementById("result").innerHTML=html;
}

window.onclick=function(e){ if(e.target==document.getElementById("modal")) closeModal(); }
</script>

</body>
</html>
